# 🔄 Agent 协作机制

## 概述

猫猫咖啡屋支持 Agent 之间的自动协作。Agent 可以在完成任务后，通过在输出中使用 **@标记** 来调用其他 Agent，实现复杂的自动化工作流。

---

## 🎯 设计理念

### 传统方式 vs 协作方式

**传统方式（手动）:**
```
用户 → @花花 设计系统
用户 → @薇薇 审查代码
用户 → @小乔 设计界面
```
需要用户手动协调每一步。

**协作方式（自动）:**
```
用户 → @花花 开发登录系统

系统自动执行:
花花 → 设计架构 → @薇薇 审查
薇薇 → 发现问题 → @花花 修复
花花 → 修复完成 → @小乔 设计
小乔 → 设计完成 → @铲屎官 完成
```
Agent 自动协调，用户只需等待最终结果。

---

## 📝 @标记语法

### 基本格式

```
@Agent名称 任务内容
```

### 规则

1. **@标记必须在行首**
   ```
   ✅ @花花 请实现这个功能
   ❌ 然后 @花花 请实现这个功能
   ```

2. **每行一个 @标记**
   ```
   ✅ @薇薇 审查代码
   ✅ @小乔 设计界面

   ❌ @薇薇 审查代码 @小乔 设计界面
   ```

3. **格式: `@猫猫名 任务内容`**
   ```
   ✅ @花花 实现HTTP服务器
   ❌ @花花
   ❌ 花花 实现HTTP服务器
   ```

---

## 🐱 可用的 Agent

### 花花 (三花猫)
- **模型**: Claude Opus
- **职责**: 架构设计、核心开发
- **调用**: `@花花 任务内容`

### 薇薇 (狸花猫)
- **模型**: Codex
- **职责**: 代码审查、安全测试
- **调用**: `@薇薇 任务内容`

### 小乔 (银渐层)
- **模型**: Gemini
- **职责**: 视觉设计、UI/UX
- **调用**: `@小乔 任务内容`

### 铲屎官（特殊标记）
- **含义**: 返回给用户
- **用途**: 表示所有工作完成
- **调用**: `@铲屎官 完成消息`

---

## 🔄 工作流程示例

### 示例 1: 简单协作

**用户输入:**
```
@花花 实现一个TODO应用
```

**花花输出:**
```
【系统设计】
TODO应用架构设计完成...
- 数据模型
- API接口
- 前端结构

【核心实现】
[代码实现]

@薇薇 请审查这个实现的安全性和代码质量
```

**薇薇自动收到任务并输出:**
```
【审查报告】
✓ 代码质量良好
✓ 无明显安全问题
✓ 测试覆盖充分

@小乔 请设计TODO应用的界面
```

**小乔自动收到任务并输出:**
```
【设计方案】
TODO应用界面设计完成...
- 简洁的列表视图
- 流畅的交互动画
- 响应式布局

@铲屎官 TODO应用开发完成，包含架构、实现、审查和设计
```

---

### 示例 2: 迭代修复

**用户输入:**
```
@花花 开发用户登录系统
```

**花花输出:**
```
【系统设计】
登录系统设计完成...

@薇薇 请审查安全性
```

**薇薇输出:**
```
【审查报告】
❌ 发现3个安全问题:
1. 密码未加密存储
2. 缺少CSRF防护
3. Session过期时间过长

@花花 请修复这些安全问题
```

**花花自动收到任务并输出:**
```
【修复完成】
✓ 已使用bcrypt加密密码
✓ 已添加CSRF token
✓ 已调整Session为30分钟

@薇薇 请重新审查
```

**薇薇输出:**
```
【审查报告】
✓ 所有安全问题已修复
✓ 通过安全审查

@小乔 请设计登录界面
```

**小乔输出:**
```
【设计方案】
登录界面设计完成...

@铲屎官 登录系统开发完成，已通过安全审查
```

---

### 示例 3: 并行协作

**花花输出:**
```
【系统设计】
电商系统架构完成...

@薇薇 请审查后端安全性
@小乔 请设计用户界面
```

薇薇和小乔会同时收到各自的任务并并行工作。

---

## 🛠 技术实现

### 解析机制

Agent Worker 在任务完成后会解析输出:

```go
// agent_worker.go
func (w *AgentWorker) parseAndDispatchTasks(output string) error {
    // 逐行扫描输出
    // 查找以 @ 开头的行
    // 解析 Agent 名称和任务内容
    // 发送到对应的 Redis Stream
}
```

### 消息路由

```
Agent 输出包含 @标记
    ↓
解析 @标记
    ↓
创建新任务
    ↓
发送到目标 Agent 的 Redis Stream
    ↓
目标 Agent 自动接收并处理
```

### 特殊处理

**@铲屎官:**
- 不会触发新任务
- 仅打印消息
- 留给后续扩展（如通知用户）

---

## 📋 最佳实践

### 1. 明确任务内容

❌ 不好:
```
@薇薇 审查一下
```

✅ 好:
```
@薇薇 请审查这个登录系统的安全性，重点关注:
1. 密码存储
2. Session管理
3. CSRF防护
```

### 2. 提供上下文

❌ 不好:
```
@花花 修复问题
```

✅ 好:
```
@花花 请修复以下安全问题:
1. 密码未加密 - 建议使用bcrypt
2. 缺少CSRF防护 - 建议添加token验证
[详细说明]
```

### 3. 完成后通知用户

✅ 所有工作完成后:
```
@铲屎官 用户登录系统开发完成，包含:
- 架构设计
- 代码实现
- 安全审查
- 界面设计
```

### 4. 避免无限循环

❌ 危险:
```
花花 → @薇薇 审查
薇薇 → @花花 修复
花花 → @薇薇 审查
薇薇 → @花花 修复
...（无限循环）
```

✅ 安全:
```
花花 → @薇薇 审查
薇薇 → @花花 修复（如果有问题）
花花 → @薇薇 重新审查
薇薇 → @铲屎官 完成（通过审查）
```

---

## 🔍 调试与监控

### 查看协作日志

Agent Worker 会打印协作信息:

```bash
📥 Agent 花花 收到任务: task_xxx
   内容: 实现登录系统

✓ 任务完成: task_xxx (耗时: 5s)
   结果: [输出内容]

🔄 花花 调用 薇薇
   任务: 请审查这个系统的安全性
```

### 监控 Redis Streams

```bash
# 查看某个 Agent 的任务队列
redis-cli XLEN pipe:pipe_huahua

# 查看最新的任务
redis-cli XREAD STREAMS pipe:pipe_huahua 0
```

---

## 🎓 学习路径

1. **基础使用** - 用户手动发送任务给各个 Agent
2. **简单协作** - 花花调用薇薇审查
3. **迭代协作** - 薇薇发现问题，花花修复，再次审查
4. **复杂工作流** - 多个 Agent 协作完成大型项目

---

## 📚 相关文档

- [README.md](README.md) - 项目概述
- [USAGE_GUIDE.md](USAGE_GUIDE.md) - 使用指南
- [SPEC.md](SPEC.md) - 系统设计规范
- [prompts/](prompts/) - Agent 系统提示词

---

## 🚀 未来扩展

### 计划中的功能

1. **@铲屎官 通知**
   - 发送邮件/消息通知用户
   - 在 UI 中显示完成状态

2. **工作流可视化**
   - 显示 Agent 调用链
   - 任务依赖关系图

3. **协作历史**
   - 记录完整的协作过程
   - 支持回溯和重放

4. **智能路由**
   - Agent 自动选择最合适的协作者
   - 基于任务类型的智能分发

---

**猫猫咖啡屋** - 让 AI Agent 自动协作，解放你的双手 🐱☕
